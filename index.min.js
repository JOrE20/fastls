class FastLS{constructor(e,t=!1,a=!0,s=!1){if(null==e)throw new Error("Database name is required");this.dbName=String(e).replace(/^(customdb:|indexeddb:|kv:)/i,""),this.gzipped=t,this.caseSen=a,this.useAsync=s,this.rootStorageKey="fastLS",this.useIndexedDB=/^(indexeddb:|kv:)/i.test(e),this.useCustomDB=/^customdb:/i.test(e),this.useLocalStorage=!this.useIndexedDB&&!this.useCustomDB,this._customData="",this.quota=null,this.folderQuotas=new Map,this.quotaMessage=null,this.useLocalStorage?this._initLocalStorage():this.useIndexedDB&&this._initIndexedDB()}_initLocalStorage(){localStorage.getItem(this.rootStorageKey)||localStorage.setItem(this.rootStorageKey,this._serializeData({}));var e=this._getRoot();e[this.dbName]||(e[this.dbName]={},this._saveRoot(e))}async _initIndexedDB(){return new Promise((t,e)=>{var a=indexedDB.open("FastLS_IndexedDB",1);a.onerror=()=>e(new Error("IndexedDB initialization failed")),a.onsuccess=e=>{this.idb=e.target.result,t()},a.onupgradeneeded=e=>{e=e.target.result;e.objectStoreNames.contains("databases")||e.createObjectStore("databases",{keyPath:"name"})}})}setQuota(e){return this.quota=e,this.quotaMessage=null}removeQuota(){return this.quota=null,this.quotaMessage=null}setFolderQuota(e,t){e=this._normalizePath(e);return this.folderQuotas.set(e,t),this.quotaMessage=null}removeFolderQuota(e){e=this._normalizePath(e);return this.folderQuotas.delete(e),this.quotaMessage=null}_calculateSize(e){return new Blob([this._serializeData(e)]).size}_checkQuotaBeforeSet(e,t,a){this.quotaMessage=null;for(var[s,r]of this.folderQuotas.entries())if(t.startsWith(s+"\\")||t===s){var s=this._calculateFolderSize(e,s),i=this._calculateSize(a);if(s-(e[t]?this._calculateSize(e[t]):0)+i>r)return i<=r?(this.quotaMessage="storedNull",{allowed:!0,storeNull:!0}):{allowed:!(this.quotaMessage="cannotSave")};break}if(null!==this.quota){var o=this._calculateSize(e),n=this._calculateSize(a),o=o-(e[t]?this._calculateSize(e[t]):0)+n;if(o>this.quota)return n<=this.quota?(this.quotaMessage="storedNull",{allowed:!0,storeNull:!0}):{allowed:!(this.quotaMessage="cannotSave")};o===this.quota&&(this.quotaMessage="meet")}return{allowed:!0,storeNull:!1}}_calculateFolderSize(e,t){let a=0;for(var[s,r]of Object.entries(e))!s.startsWith(t+"\\")&&s!==t||(a+=this._calculateSize(r));return a}_getRoot(){try{var e;return this.useLocalStorage?(e=localStorage.getItem(this.rootStorageKey))?this._deserializeData(e):{}:{}}catch{return{}}}_saveRoot(e){try{return this.useLocalStorage&&localStorage.setItem(this.rootStorageKey,this._serializeData(e)),null}catch(e){return e.message}}async _getDatabase(){return this.useLocalStorage&&!this.useAsync?this._getRoot()[this.dbName]||{}:this.useLocalStorage&&this.useAsync?new Promise(t=>{setTimeout(()=>{var e=this._getRoot();t(e[this.dbName]||{})},0)}):this.useIndexedDB?(this.idb||await this._initIndexedDB(),new Promise((t,e)=>{var a=this.idb.transaction(["databases"],"readonly").objectStore("databases").get(this.dbName);a.onerror=()=>e(new Error("IndexedDB read failed")),a.onsuccess=e=>{t(e.target.result?e.target.result.data:{})}})):this.useCustomDB?this.useAsync?new Promise(e=>{setTimeout(()=>{e(this._customData?this._deserializeData(this._customData):{})},0)}):this._customData?this._deserializeData(this._customData):{}:void 0}async _saveDatabase(s){var e;return this.useLocalStorage&&!this.useAsync?((e=this._getRoot())[this.dbName]=s,this._saveRoot(e)):this.useLocalStorage&&this.useAsync?new Promise(t=>{setTimeout(()=>{var e=this._getRoot(),e=(e[this.dbName]=s,this._saveRoot(e));t(e)},0)}):this.useIndexedDB?(this.idb||await this._initIndexedDB(),new Promise((e,t)=>{var a=this.idb.transaction(["databases"],"readwrite").objectStore("databases").put({name:this.dbName,data:s});a.onerror=()=>t(new Error("IndexedDB write failed")),a.onsuccess=()=>e(null)})):this.useCustomDB?this.useAsync?new Promise(e=>{setTimeout(()=>{this._customData=this._serializeData(s),e(null)},0)}):(this._customData=this._serializeData(s),null):void 0}_executeSync(e){if(!this.useLocalStorage||this.useIndexedDB){console.warn("Synchronous mode not fully supported for IndexedDB. Some operations may not work as expected.");let t;return e().then(e=>t=e).catch(e=>{throw e}),t}try{var t,a,s,r,i,o,n,u=this._getRoot(),h=u[this.dbName]||{};return"getOperation"===e.name?(t=this._parseFullPath(e).path,(a=h[t])&&a.__fastls_exception_shortcut?this.get(a.__fastls_exception_shortcut):this._getValueByPath(h,t)):"setOperation"===e.name?(s=this._parseFullPath(e).path,r=arguments[1],(i=this._checkQuotaBeforeSet(h,s,r)).allowed&&(o=i.storeNull?null:r,n=this._setValueByPath(h,s,o),u[this.dbName]=n,this._saveRoot(u)),i):void 0}catch(e){console.error("Sync operation error:",e)}}_serializeData(e){e=JSON.stringify(e,(e,t)=>{var a;return"function"==typeof t?{__fastls_exception_function:`function(${(a=t.toString().match(/\((.*?)\)/))?a[1]:""})`}:(t&&t.__fastls_exception_shortcut,t)});return this.gzipped&&"undefined"!=typeof window&&window.pako?btoa(String.fromCharCode(...pako.gzip(e))):e}_deserializeData(e){if(!e)return{};let t=e;if(this.gzipped&&"undefined"!=typeof window&&window.pako)try{var a=Uint8Array.from(atob(e),e=>e.charCodeAt(0));t=pako.ungzip(a,{to:"string"})}catch(e){}try{return JSON.parse(t,(e,t)=>t&&t.__fastls_exception_function?{__fastls_function:t.__fastls_exception_function}:(t&&t.__fastls_exception_shortcut,t))}catch(e){return console.error("Deserialization error:",e),{}}}_normalizePath(e){if(!e||"string"!=typeof e)return"";var t,a=[];for(t of(e=e.replace(/^[^:]+:/,"")).split(/[\\/]/))".."===t?a.pop():""!==t&&"."!==t&&a.push(t);return a.join("\\")}_validatePath(e){if(e&&(e.includes(":")||e.includes("\\")))throw new Error('Path cannot contain ":" or "\\" in key names');if(".."===e)throw new Error('Path cannot be ".."')}_parseFullPath(e){var t;return"string"!=typeof e?{dbName:null,path:""}:(t=e.match(/^([^:]+):(.*)$/))?{dbName:t[1],path:this._normalizePath(t[2])}:{dbName:null,path:this._normalizePath(e)}}_getValueByPath(e,t){if(!t||!e)return e;let a=e;for(const i of t.split(".")){if(null===a||void 0===a||"object"!=typeof a)return;var s=i.match(/(\w+)\[(\d+)\]/);if(s){var r=s[1],s=parseInt(s[2]);if(!a[r]||!Array.isArray(a[r]))return;a=a[r][s]}else a=this.caseSen||"object"!=typeof a?a[i]:(r=Object.keys(a).find(e=>e.toLowerCase()===i.toLowerCase()))?a[r]:void 0;if(void 0===a)break}return a}_setValueByPath(e,t,a){if(!t)return a;var s=t.split(".");let r=e||{};for(let e=0;e<s.length-1;e++){const c=s[e];var i=c.match(/(\w+)\[(\d+)\]/);if(i){var o=i[1],n=parseInt(i[2]);for(r[o]&&Array.isArray(r[o])||(r[o]=[]);r[o].length<=n;)r[o].push({});r=r[o][n]}else{let e=c;this.caseSen||"object"!=typeof r||(i=Object.keys(r).find(e=>e.toLowerCase()===c.toLowerCase()),e=i||c),null!==r[e]&&void 0!==r[e]&&"object"==typeof r[e]||(r[e]={}),r=r[e]}}const u=s[s.length-1];var t=u.match(/(\w+)\[(\d+)\]/);if(t){var h=t[1],l=parseInt(t[2]);for(r[h]&&Array.isArray(r[h])||(r[h]=[]);r[h].length<=l;)r[h].push(void 0);r[h][l]=a}else{let e=u;this.caseSen||"object"!=typeof r||(t=Object.keys(r).find(e=>e.toLowerCase()===u.toLowerCase()),e=t||u),r[e]=a}return e}get(i){var e=async()=>{try{var{dbName:t,path:a}=this._parseFullPath(i);let e=this;t&&t!==this.dbName&&(e=new FastLS(t,this.gzipped,this.caseSen,this.useAsync)).useIndexedDB&&await e._initIndexedDB();var s=await e._getDatabase(),r=s[a];return r&&r.__fastls_exception_shortcut?e.get(r.__fastls_exception_shortcut):this._getValueByPath(s,a)}catch(e){console.error("FastLS get error:",e)}};return this.useAsync?e():(e.name="getOperation",this._executeSync(e))}set(n,u){var e=async()=>{try{var{dbName:t,path:a}=this._parseFullPath(n);a&&this._validatePath(a);let e=this;t&&t!==this.dbName&&(e=new FastLS(t,this.gzipped,this.caseSen,this.useAsync)).useIndexedDB&&await e._initIndexedDB();var s,r,i=await e._getDatabase(),o=this._checkQuotaBeforeSet(i,a,u);return o.allowed?(s=o.storeNull?null:u,r=this._setValueByPath(i,a,s),{saveResult:await e._saveDatabase(r),quotaCheck:o,quotaMessage:this.quotaMessage}):o}catch(e){return console.error("FastLS set error:",e),e.message}};return this.useAsync?e():(e.name="setOperation",this._executeSync(e))}setShortcut(e,t){return this.set(e,{__fastls_exception_shortcut:t})}search(a,n,u=!1){var e=async()=>{try{var e=await this._getDatabase(),t=this._getValueByPath(e,a);const i=[],o=(e,t="")=>{if(e&&"object"==typeof e)for(var[a,s]of Object.entries(e)){var r=t?t+"."+a:a;(u?n(a,s):n(s))&&i.push(s),s&&"object"==typeof s&&!Array.isArray(s)&&o(s,r)}};return o(t),i}catch(e){return console.error("FastLS search error:",e),[]}};return this.useAsync?e():this._executeSync(e)}path(a,n,u=!1){var e=async()=>{try{var e=await this._getDatabase(),t=this._getValueByPath(e,a);let i=null;const o=(e,t="")=>{if(e&&"object"==typeof e)for(var[a,s]of Object.entries(e)){var r=t?t+"."+a:a;if(u?n(a,s):n(s))return i=r,!0;if(s&&"object"==typeof s&&!Array.isArray(s)&&o(s,r))return!0}return!1};return o(t),i}catch(e){return console.error("FastLS path error:",e),null}};return this.useAsync?e():this._executeSync(e)}remove(...o){var e=async()=>{try{let t={...await this._getDatabase()};for(let e=0;e<o.length;e+=2){var a,s=o[e],r=o[e+1];if(null===s&&"database"===r){if(this.useLocalStorage)return delete(a=this._getRoot())[this.dbName],this._saveRoot(a),null;if(this.useIndexedDB)return this.idb.transaction(["databases"],"readwrite").objectStore("databases").delete(this.dbName),null;if(this.useCustomDB)return this._customData="",null}if(null!==s&&""!==s&&"\\"!==s||"databaseKeys"!==r){var i=this._normalizePath(s);switch(r){case"folder":t=this._deleteFolder(t,i);break;case"root":t=this._deleteRootKeys(t,i);break;case"structure":t=this._deleteFolderContents(t,i);break;case"nestedFolders":t=this._deleteNestedFolders(t,i);break;default:console.warn("Unknown removal operation: "+r)}}else t={}}return await this._saveDatabase(t)}catch(e){return console.error("FastLS remove error:",e),e.message}};return this.useAsync?e():this._executeSync(e)}_deleteFolder(e,t){var a,s,r={};for([a,s]of Object.entries(e))a.startsWith(t+"\\")||a===t||(r[a]=s);return r}_deleteRootKeys(e,t){var a,s,r={};for([a,s]of Object.entries(e))a.startsWith(t+"\\")&&(!a.startsWith(t+"\\")||a.substring(t.length+1).includes("\\"))||(r[a]=s);return r}_deleteFolderContents(e,t){var a,s,r={};for([a,s]of Object.entries(e))a.startsWith(t+"\\")||a===t?r[a]={}:r[a]=s;return r}_deleteNestedFolders(e,t){var a,s,r={};for([a,s]of Object.entries(e))a.startsWith(t+"\\")&&(!a.startsWith(t+"\\")||a.substring(t.length+1).includes("\\"))||(r[a]=s);return r}removeKey(r){var e=async()=>{try{var{dbName:t,path:a}=this._parseFullPath(r);let e=this;t&&t!==this.dbName&&(e=new FastLS(t,this.gzipped,this.caseSen,this.useAsync)).useIndexedDB&&await e._initIndexedDB();var s=await e._getDatabase();return s.hasOwnProperty(a)?(delete s[a],await e._saveDatabase(s)):null}catch(e){return console.error("FastLS removeKey error:",e),e.message}};return this.useAsync?e():this._executeSync(e)}get data(){return this.useCustomDB?this._customData:null}set data(e){this.useCustomDB&&(this._customData=e)}get dataBlob(){return this.useCustomDB&&"undefined"!=typeof Blob?new Blob([this._customData],{type:"application/octet-stream"}):null}downloadDB(t="database.db",a=!0){if("undefined"!=typeof window&&this.useCustomDB){let e=this._customData;a||(e=e&&btoa(e));var a=new Blob([e],{type:"application/octet-stream"}),a=URL.createObjectURL(a),s=document.createElement("a");s.href=a,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}else console.warn("downloadDB only works in browser environment with CustomDB")}uploadDB(e,a=!0){var t;"undefined"!=typeof window&&this.useCustomDB?((t=document.createElement("input")).type="file",t.accept=".db",t.onchange=e=>{var e=e.target.files[0],t=new FileReader;t.onload=e=>{let t=e.target.result;if(a&&t)try{t=atob(t)}catch(e){console.error("Error decoding base64 data:",e)}this._customData=t},t.readAsText(e)},t.click()):console.warn("uploadDB only works in browser environment with CustomDB")}has(e){var t=async()=>{return void 0!==await this.get(e)};return this.useAsync?t():this._executeSync(t)}keys(){var e=async()=>{var e=await this._getDatabase();return Object.keys(e)};return this.useAsync?e():this._executeSync(e)}values(){var e=async()=>{var e=await this._getDatabase();return Object.values(e)};return this.useAsync?e():this._executeSync(e)}entries(){var e=async()=>{var e=await this._getDatabase();return Object.entries(e)};return this.useAsync?e():this._executeSync(e)}clear(){var e=async()=>this._saveDatabase({});return this.useAsync?e():this._executeSync(e)}size(){var e=async()=>{var e=await this._getDatabase();return new Blob([this._serializeData(e)]).size};return this.useAsync?e():this._executeSync(e)}count(){var e=async()=>{var e=await this._getDatabase();return Object.keys(e).length};return this.useAsync?e():this._executeSync(e)}static listDatabases(){try{var e=JSON.parse(localStorage.getItem("fastLS")||"{}");return Object.keys(e)}catch{return[]}}static removeAllDatabases(){try{return localStorage.removeItem("fastLS"),null}catch(e){return e.message}}}"undefined"!=typeof module&&module.exports&&(module.exports=FastLS),"undefined"!=typeof window&&(window.FastLS=FastLS);