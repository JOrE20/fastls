class FastLS{constructor(e,t=!1,s=!0,a=!1){if(e&&e.startsWith("auto:")){if(e=e.substring(5),"undefined"!=typeof indexedDB)try{var r=indexedDB.open("test");r.onerror=()=>{this.useIndexedDB=!1,this.useLocalStorage=!0},r.onsuccess=()=>{this.useIndexedDB=!0,this.useLocalStorage=!1,indexedDB.deleteDatabase("test")}}catch{this.useIndexedDB=!1,this.useLocalStorage=!0}else this.useIndexedDB=!1,this.useLocalStorage=!0;this.useCustomDB=!1}else{if(null==e)throw new Error("Database name is required");this.useIndexedDB=/^(indexeddb:|kv:)/i.test(e),this.useCustomDB=/^customdb:/i.test(e),this.useLocalStorage=!this.useIndexedDB&&!this.useCustomDB}if(this.dbName=String(e).replace(/^(customdb:|indexeddb:|kv:|auto:)/i,""),this.dbName.includes("/"))throw new Error('Database name cannot contain "/"');this.gzipped=t,this.caseSen=s,this.useAsync=a,this.rootStorageKey="fastLS",this._customData="",this.quota=null,this.folderQuotas=new Map,this.quotaMessage=null,this.useLocalStorage?this._initLocalStorage():this.useIndexedDB&&this._initIndexedDB()}_initLocalStorage(){localStorage.getItem(this.rootStorageKey)||localStorage.setItem(this.rootStorageKey,this._serializeData({}));var e=this._getRoot();e[this.dbName]||(e[this.dbName]={},this._saveRoot(e))}async _initIndexedDB(){return new Promise((t,e)=>{var s=indexedDB.open("FastLS_IndexedDB",1);s.onerror=()=>e(new Error("IndexedDB initialization failed")),s.onsuccess=e=>{this.idb=e.target.result,t()},s.onupgradeneeded=e=>{e=e.target.result;e.objectStoreNames.contains("databases")||e.createObjectStore("databases",{keyPath:"name"})}})}setQuota(e){return this.quota=e,this.quotaMessage=null}removeQuota(){return this.quota=null,this.quotaMessage=null}setFolderQuota(e,t){e=this._normalizePath(e);return this.folderQuotas.set(e,t),this.quotaMessage=null}removeFolderQuota(e){e=this._normalizePath(e);return this.folderQuotas.delete(e),this.quotaMessage=null}_calculateSize(e){return new Blob([this._serializeData(e)]).size}_checkQuotaBeforeSet(e,t,s){this.quotaMessage=null;for(var[a,r]of this.folderQuotas.entries())if(t.startsWith(a+"\\")||t===a){var a=this._calculateFolderSize(e,a),i=this._calculateSize(s);if(a-(e[t]?this._calculateSize(e[t]):0)+i>r)return{allowed:!(this.quotaMessage="cannotSave")};break}if(null!==this.quota){var o=this._calculateSize(e),n=this._calculateSize(s),o=o-(e[t]?this._calculateSize(e[t]):0)+n;if(o>this.quota)return{allowed:!(this.quotaMessage="cannotSave")};o===this.quota&&(this.quotaMessage="meet")}return{allowed:!0}}_calculateFolderSize(e,t){let s=0;for(var[a,r]of Object.entries(e))!a.startsWith(t+"\\")&&a!==t||(s+=this._calculateSize(r));return s}_getRoot(){try{var e;return this.useLocalStorage?(e=localStorage.getItem(this.rootStorageKey))?this._deserializeData(e):{}:{}}catch{return{}}}_saveRoot(e){try{return this.useLocalStorage&&localStorage.setItem(this.rootStorageKey,this._serializeData(e)),null}catch(e){return e.message}}async _getDatabase(){return this.useLocalStorage&&!this.useAsync?this._getRoot()[this.dbName]||{}:this.useLocalStorage&&this.useAsync?new Promise(t=>{setTimeout(()=>{var e=this._getRoot();t(e[this.dbName]||{})},0)}):this.useIndexedDB?(this.idb||await this._initIndexedDB(),new Promise((t,e)=>{var s=this.idb.transaction(["databases"],"readonly").objectStore("databases").get(this.dbName);s.onerror=()=>e(new Error("IndexedDB read failed")),s.onsuccess=e=>{t(e.target.result?e.target.result.data:{})}})):this.useCustomDB?this.useAsync?new Promise(e=>{setTimeout(()=>{e(this._customData?this._deserializeData(this._customData):{})},0)}):this._customData?this._deserializeData(this._customData):{}:void 0}async _saveDatabase(a){var e;return this.useLocalStorage&&!this.useAsync?((e=this._getRoot())[this.dbName]=a,this._saveRoot(e)):this.useLocalStorage&&this.useAsync?new Promise(t=>{setTimeout(()=>{var e=this._getRoot(),e=(e[this.dbName]=a,this._saveRoot(e));t(e)},0)}):this.useIndexedDB?(this.idb||await this._initIndexedDB(),new Promise((e,t)=>{var s=this.idb.transaction(["databases"],"readwrite").objectStore("databases").put({name:this.dbName,data:a});s.onerror=()=>t(new Error("IndexedDB write failed")),s.onsuccess=()=>e(null)})):this.useCustomDB?this.useAsync?new Promise(e=>{setTimeout(()=>{this._customData=this._serializeData(a),e(null)},0)}):(this._customData=this._serializeData(a),null):void 0}_executeSync(e){if(!this.useLocalStorage||this.useIndexedDB||this.useCustomDB){console.warn("Synchronous mode not fully supported for IndexedDB/CustomDB. Some operations may not work as expected.");let t;return(async()=>e.fn())().then(e=>t=e).catch(e=>{throw e}),t}try{var t,s,a,r,i,o,n=this._getRoot(),u=n[this.dbName]||{};return"get"===e.type?(s=u[t=e.path])&&s.__fastls_exception_shortcut?this.get(s.__fastls_exception_shortcut):this._getValueByPath(u,t):"set"===e.type?(a=e.path,r=e.value,(i=this._checkQuotaBeforeSet(u,a,r)).allowed?(o=this._setValueByPath(u,a,r),n[this.dbName]=o,{saveResult:this._saveRoot(n),quotaCheck:i,quotaMessage:this.quotaMessage}):{error:"quota_exceeded",message:this.quotaMessage}):void 0}catch(e){console.error("Sync operation error:",e)}}_serializeData(e){e=JSON.stringify(e,(e,t)=>{var s;return"function"==typeof t?{__fastls_exception_function:`function(${(s=t.toString().match(/\((.*?)\)/))?s[1]:""})`}:(!t||!t.__fastls_exception_shortcut)&&t instanceof Blob?{__fastls_blob:!0,type:t.type,size:t.size}:t});return this.gzipped&&"undefined"!=typeof window&&window.pako?btoa(String.fromCharCode(...pako.gzip(e))):e}_deserializeData(e){if(!e)return{};let t=e;if(this.gzipped&&"undefined"!=typeof window&&window.pako)try{var s=Uint8Array.from(atob(e),e=>e.charCodeAt(0));t=pako.ungzip(s,{to:"string"})}catch(e){}try{return JSON.parse(t,(e,t)=>t&&t.__fastls_exception_function?{__fastls_function:t.__fastls_exception_function}:(!t||!t.__fastls_exception_shortcut)&&t&&t.__fastls_blob&&"undefined"!=typeof Blob?new Blob([],{type:t.type}):t)}catch(e){return console.error("Deserialization error:",e),{}}}_normalizePath(e){if(!e||"string"!=typeof e)return"";var t,s=[];for(t of(e=e.replace(/^[^:]+:/,"")).split(/[\\/]/))".."===t?s.pop():""!==t&&"."!==t&&s.push(t);return s.join("\\")}_validatePath(e){if(e&&e.includes(":"))throw new Error('Path cannot contain ":" in key names');if(".."===e)throw new Error('Path cannot be ".."')}_parseFullPath(e){var t;return"string"!=typeof e?{dbName:null,path:""}:(t=e.match(/^([^:]+):(.*)$/))?{dbName:t[1],path:this._normalizePath(t[2])}:{dbName:null,path:this._normalizePath(e)}}_getValueByPath(e,t){if(!t||!e)return e;let s=e;for(const i of t.split(".")){if(null===s||void 0===s||"object"!=typeof s)return;var a=i.match(/(\w+)\[(\d+)\]/);if(a){var r=a[1],a=parseInt(a[2]);if(!s[r]||!Array.isArray(s[r]))return;s=s[r][a]}else s=this.caseSen||"object"!=typeof s?s[i]:(r=Object.keys(s).find(e=>e.toLowerCase()===i.toLowerCase()))?s[r]:void 0;if(void 0===s)break}return s}_setValueByPath(e,t,s){if(!t)return s;var a=t.split(".");let r=e||{};for(let e=0;e<a.length-1;e++){const l=a[e];var i=l.match(/(\w+)\[(\d+)\]/);if(i){var o=i[1],n=parseInt(i[2]);for(r[o]&&Array.isArray(r[o])||(r[o]=[]);r[o].length<=n;)r[o].push({});r=r[o][n]}else{let e=l;this.caseSen||"object"!=typeof r||(i=Object.keys(r).find(e=>e.toLowerCase()===l.toLowerCase()),e=i||l),null!==r[e]&&void 0!==r[e]&&"object"==typeof r[e]||(r[e]={}),r=r[e]}}const u=a[a.length-1];var t=u.match(/(\w+)\[(\d+)\]/);if(t){var h=t[1],c=parseInt(t[2]);for(r[h]&&Array.isArray(r[h])||(r[h]=[]);r[h].length<=c;)r[h].push(void 0);r[h][c]=s}else{let e=u;this.caseSen||"object"!=typeof r||(t=Object.keys(r).find(e=>e.toLowerCase()===u.toLowerCase()),e=t||u),r[e]=s}return e}get(e){let{dbName:a,path:r}=this._parseFullPath(e);return this.useAsync||this.useIndexedDB||this.useCustomDB?(async()=>{try{let e=this;a&&a!==this.dbName&&(e=new FastLS(a,this.gzipped,this.caseSen,this.useAsync)).useIndexedDB&&await e._initIndexedDB();var t=await e._getDatabase(),s=t[r];return s&&s.__fastls_exception_shortcut?e.get(s.__fastls_exception_shortcut):this._getValueByPath(t,r)}catch(e){console.error("FastLS get error:",e)}})():this._executeSync({type:"get",path:r,fn:()=>this.get(e)})}set(e,r){let{dbName:i,path:o}=this._parseFullPath(e);return o&&this._validatePath(o),this.useAsync||this.useIndexedDB||this.useCustomDB?(async()=>{try{let e=this;i&&i!==this.dbName&&(e=new FastLS(i,this.gzipped,this.caseSen,this.useAsync)).useIndexedDB&&await e._initIndexedDB();var t,s=await e._getDatabase(),a=this._checkQuotaBeforeSet(s,o,r);return a.allowed?(t=this._setValueByPath(s,o,r),{saveResult:await e._saveDatabase(t),quotaCheck:a,quotaMessage:this.quotaMessage}):{error:"quota_exceeded",quotaCheck:a,quotaMessage:this.quotaMessage}}catch(e){return console.error("FastLS set error:",e),{error:e.message}}})():this._executeSync({type:"set",path:o,value:r,fn:()=>this.set(e,r)})}clean(i,o,n=!1){var e=async()=>{try{var t,s,a=await this._getDatabase(),r=this._normalizePath(i);let e=0;for([t,s]of Object.entries(a))!t.startsWith(r+"\\")&&t!==r||(n?o(t,s):o(s))||(delete a[t],e++);return await this._saveDatabase(a),e}catch(e){return console.error("FastLS clean error:",e),-1}};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}createFolder(i){var e=async()=>{try{var t=this._normalizePath(i),s=await this._getDatabase(),a=t.split("\\");let e="";for(const r of a)e&&(e+="\\"),s[e+=r]||(s[e]={});return await this._saveDatabase(s),t}catch(e){return console.error("FastLS createFolder error:",e),null}};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}setShortcut(e,t){return this.set(e,{__fastls_exception_shortcut:t})}search(s,n,u=!1){var e=async()=>{try{var e=await this._getDatabase(),t=this._getValueByPath(e,s);const i=[],o=(e,t="")=>{if(e&&"object"==typeof e)for(var[s,a]of Object.entries(e)){var r=t?t+"."+s:s;(u?n(s,a):n(a))&&i.push(a),a&&"object"==typeof a&&!Array.isArray(a)&&o(a,r)}};return o(t),i}catch(e){return console.error("FastLS search error:",e),[]}};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}path(s,n,u=!1){var e=async()=>{try{var e=await this._getDatabase(),t=this._getValueByPath(e,s);let i=null;const o=(e,t="")=>{if(e&&"object"==typeof e)for(var[s,a]of Object.entries(e)){var r=t?t+"."+s:s;if(u?n(s,a):n(a))return i=r,!0;if(a&&"object"==typeof a&&!Array.isArray(a)&&o(a,r))return!0}return!1};return o(t),i}catch(e){return console.error("FastLS path error:",e),null}};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}remove(...o){var e=async()=>{try{let t={...await this._getDatabase()};for(let e=0;e<o.length;e+=2){var s,a=o[e],r=o[e+1];if(null===a&&"database"===r){if(this.useLocalStorage)return delete(s=this._getRoot())[this.dbName],this._saveRoot(s),null;if(this.useIndexedDB)return this.idb.transaction(["databases"],"readwrite").objectStore("databases").delete(this.dbName),null;if(this.useCustomDB)return this._customData="",null}if(null!==a&&""!==a&&"\\"!==a||"databaseKeys"!==r){var i=this._normalizePath(a);switch(r){case"folder":t=this._deleteFolder(t,i);break;case"root":t=this._deleteRootKeys(t,i);break;case"structure":t=this._deleteFolderContents(t,i);break;case"nestedFolders":t=this._deleteNestedFolders(t,i);break;default:console.warn("Unknown removal operation: "+r)}}else t={}}return await this._saveDatabase(t)}catch(e){return console.error("FastLS remove error:",e),e.message}};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}_deleteFolder(e,t){var s,a,r={};for([s,a]of Object.entries(e))s.startsWith(t+"\\")||s===t||(r[s]=a);return r}_deleteRootKeys(e,t){var s,a,r={};for([s,a]of Object.entries(e))s.startsWith(t+"\\")&&(!s.startsWith(t+"\\")||s.substring(t.length+1).includes("\\"))||(r[s]=a);return r}_deleteFolderContents(e,t){var s,a,r={};for([s,a]of Object.entries(e))s.startsWith(t+"\\")||s===t?r[s]={}:r[s]=a;return r}_deleteNestedFolders(e,t){var s,a,r={};for([s,a]of Object.entries(e))s.startsWith(t+"\\")&&(!s.startsWith(t+"\\")||s.substring(t.length+1).includes("\\"))||(r[s]=a);return r}removeKey(r){var e=async()=>{try{var{dbName:t,path:s}=this._parseFullPath(r);let e=this;t&&t!==this.dbName&&(e=new FastLS(t,this.gzipped,this.caseSen,this.useAsync)).useIndexedDB&&await e._initIndexedDB();var a=await e._getDatabase();return a.hasOwnProperty(s)?(delete a[s],await e._saveDatabase(a)):null}catch(e){return console.error("FastLS removeKey error:",e),e.message}};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}get data(){return this.useCustomDB?this._customData:null}set data(e){this.useCustomDB&&(this._customData=e)}get dataBlob(){return this.useCustomDB&&"undefined"!=typeof Blob?new Blob([this._customData],{type:"application/octet-stream"}):null}downloadDB(t="database.db",s=!0){if("undefined"!=typeof window&&this.useCustomDB){let e=this._customData;s||(e=e&&btoa(e));var s=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(s),a=document.createElement("a");a.href=s,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}else console.warn("downloadDB only works in browser environment with CustomDB")}uploadDB(e,s=!0){var t;"undefined"!=typeof window&&this.useCustomDB?((t=document.createElement("input")).type="file",t.accept=".db",t.onchange=e=>{var e=e.target.files[0],t=new FileReader;t.onload=e=>{let t=e.target.result;if(s&&t)try{t=atob(t)}catch(e){console.error("Error decoding base64 data:",e)}this._customData=t},t.readAsText(e)},t.click()):console.warn("uploadDB only works in browser environment with CustomDB")}has(e){var t=async()=>{return void 0!==await this.get(e)};return this.useAsync||this.useIndexedDB?t():this._executeSync({fn:t})}keys(){var e=async()=>{var e=await this._getDatabase();return Object.keys(e)};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}values(){var e=async()=>{var e=await this._getDatabase();return Object.values(e)};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}entries(){var e=async()=>{var e=await this._getDatabase();return Object.entries(e)};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}clear(){var e=async()=>this._saveDatabase({});return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}size(){var e=async()=>{var e=await this._getDatabase();return new Blob([this._serializeData(e)]).size};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}count(){var e=async()=>{var e=await this._getDatabase();return Object.keys(e).length};return this.useAsync||this.useIndexedDB?e():this._executeSync({fn:e})}static listDatabases(){try{var e=JSON.parse(localStorage.getItem("fastLS")||"{}");return Object.keys(e)}catch{return[]}}static removeAllDatabases(){try{return localStorage.removeItem("fastLS"),null}catch(e){return e.message}}}"undefined"!=typeof module&&module.exports&&(module.exports=FastLS),"undefined"!=typeof window&&(window.FastLS=FastLS);
